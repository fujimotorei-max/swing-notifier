name: swing-notifier

concurrency:
  group: swing-notifier
  cancel-in-progress: true

on:
  schedule:
    # åˆå‰ï¼ˆJST 09:00â€“11:30ï¼‰= UTC 00:00â€“02:30
    - cron: "0,30 0-2 * * 1-5"
    # åˆå¾Œé–‹å§‹ã®12:30ï¼ˆJSTï¼‰= UTC 03:30
    - cron: "30 3 * * 1-5"
    # åˆå¾Œï¼ˆJST 13:00â€“14:30ï¼‰= UTC 04:00â€“05:30
    - cron: "0,30 4-5 * * 1-5"
    # å¼•ã‘ï¼ˆJST 15:00ï¼‰= UTC 06:00
    - cron: "0 6 * * 1-5"
  workflow_dispatch: {}   # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³

permissions:
  contents: write         # stateãƒ–ãƒ©ãƒ³ãƒã«pushã™ã‚‹ãŸã‚

defaults:
  run:
    shell: bash           # ã™ã¹ã¦bashã§å®Ÿè¡Œï¼ˆæ§‹æ–‡ã‚¨ãƒ©ãƒ¼ã‚’é¿ã‘ã‚‹ï¼‰

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ï¼ˆä»»æ„ï¼‰pipã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€‚ä¸è¦ãªã‚‰ã“ã®ãƒ–ãƒ­ãƒƒã‚¯ã¯å‰Šé™¤OK
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install -r requirements.txt

      # stateãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ trade_state.json ã‚’å¾©å…ƒ
      - name: Restore state file if exists
        run: |
          set -euo pipefail
          if git ls-remote --exit-code origin state >/dev/null 2>&1; then
            echo "state branch exists. Restoring trade_state.json ..."
            git fetch origin state
            if git cat-file -e origin/state:trade_state.json 2>/dev/null; then
              git show origin/state:trade_state.json > trade_state.json
            else
              printf "{}" > trade_state.json
            fi
          else
            echo "state branch not found. Create empty state."
            printf "{}" > trade_state.json
          fi

      # æ‰‹å‹•Runã®æ™‚ã ã‘LINEã«ãƒ†ã‚¹ãƒˆé€šçŸ¥ï¼ˆå®šæœŸRunã§ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ï¼‰
      - name: LINE ping (manual runs only)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        env:
          CHANNEL_ACCESS_TOKEN: ${{ secrets.CHANNEL_ACCESS_TOKEN }}
        run: |
          python - <<'PY'
          import os, requests
          token = os.environ["CHANNEL_ACCESS_TOKEN"]
          resp = requests.post(
              "https://api.line.me/v2/bot/message/broadcast",
              headers={"Authorization": f"Bearer {token}", "Content-Type": "application/json"},
              json={"messages":[{"type":"text","text":"ğŸ”” GitHub Actions ã‹ã‚‰ã®æ‰‹å‹•ãƒ†ã‚¹ãƒˆé€šçŸ¥"}]}
          )
          print("LINE status:", resp.status_code, resp.text[:200])
          PY

      - name: Run notifier
        env:
          CHANNEL_ACCESS_TOKEN: ${{ secrets.CHANNEL_ACCESS_TOKEN }}
        run: python swing_notifier.py

      # trade_state.json ã‚’ state ãƒ–ãƒ©ãƒ³ãƒã«ä¿å­˜
      - name: Save state back to branch
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git ls-remote --exit-code origin state >/dev/null 2>&1; then
            git worktree add ../state-worktree origin/state
          else
            git worktree add -b state ../state-worktree HEAD
            pushd ../state-worktree
            rm -rf ./*
            git commit --allow-empty -m "init state branch"
            git push -u origin state
            popd
          fi

          cp -f trade_state.json ../state-worktree/trade_state.json
          pushd ../state-worktree
          if git diff --quiet -- trade_state.json; then
            echo "No state changes."
          else
            git add trade_state.json
            git commit -m "update state"
            git push origin state
          fi
          popd
